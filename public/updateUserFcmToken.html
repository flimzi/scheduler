<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js'
        
        async function updateUserFcmToken() {
            const params = new URLSearchParams(new URL(window.location.href).search)
            const [ userId, fcmUpdateEndpoint, testEndpoint, accessToken ] = [ params.get('userId'), params.get('fcmUpdateEndpoint'), params.get('testEndpoint'), params.get('accessToken') ]

            if ([userId, fcmUpdateEndpoint, testEndpoint, accessToken].includes(undefined))
                throw new Error()

            const firebaseConfig = {
                apiKey: 'AIzaSyDXK9ntNlAO06WLV2r4oJoneKyJxuCaXhQ',
                authDomain: 'zwardon-12120.firebaseapp.com',
                projectId: 'zwardon-12120',
                storageBucket: 'zwardon-12120.appspot.com',
                messagingSenderId: '784564826365',
                appId: '1:784564826365:web:416361d6933884a0208e94'
            }
        
            const app = initializeApp(firebaseConfig)
            const messaging = getMessaging(app)
            const permission = await Notification.requestPermission()

            if (permission !== 'granted')
                throw new Error()

            onMessage(messaging, handleMessage)

            const token = await getToken(messaging, { vapidKey: 'BFmnKydepWdCfhzgp5pgZyoUcHA1PxAaptYk9Hw_SBAhiw2yajiVUINUQ7IathPmR6bcLI72xceaqYk7trYVYvo' })

            if (!token)
                throw new Error()

            // only do this on app startup
            const updateResponse = await fetch(atob(fcmUpdateEndpoint), {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: token
            })

            if (!updateResponse.ok)
                throw new Error()

            const testUrl = new URL(atob(testEndpoint))
            testUrl.searchParams.append('token', token)
            testUrl.searchParams.append('repeat', 10)
            
            const messageResponse = await fetch(testUrl.toString(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify({ test1: 'test1', test2: 'test2' })
            })

            console.log(messageResponse)
        }

        function handleMessage(payload) {
            console.log('foreground notification', payload)
            new Notification(payload.notification.title, { body: payload.notification.body })
        }

        await updateUserFcmToken()
    </script>
</body>
</html>