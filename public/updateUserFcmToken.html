<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js'
        
        const fcmTokenEndpoint = '/api/user/current/fcmToken'
        const testEndpoint = ''

        const firebaseConfig = {
            apiKey: 'AIzaSyDXK9ntNlAO06WLV2r4oJoneKyJxuCaXhQ',
            authDomain: 'zwardon-12120.firebaseapp.com',
            projectId: 'zwardon-12120',
            storageBucket: 'zwardon-12120.appspot.com',
            messagingSenderId: '784564826365',
            appId: '1:784564826365:web:416361d6933884a0208e94'
        }
    
        const app = initializeApp(firebaseConfig)
        const messaging = getMessaging(app)
        const permission = await Notification.requestPermission()

        if (permission !== 'granted')
            throw new Error('notification permission not granted')

        onMessage(messaging, handleMessage)

        window.getFcmToken = async function getFcmToken() {
            const token = await getToken(messaging, { vapidKey: 'BFmnKydepWdCfhzgp5pgZyoUcHA1PxAaptYk9Hw_SBAhiw2yajiVUINUQ7IathPmR6bcLI72xceaqYk7trYVYvo' })

            if (!token)
                throw new Error('token fetch error')

            return token
        }

        window.updateUserFcmToken = async function updateUserFcmToken(accessToken) {
            const updateResponse = await fetch(fcmTokenEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: await getFcmToken()
            })

            if (!updateResponse.ok)
                throw new Error('update endpoint error ' + updateResponse.status)

            return true
        }

        window.testUserFcm = async function testUserFcm(acessToken) {
            // todo
        }

        function handleMessage(payload) {
            console.log('foreground notification', payload)
            new Notification(payload.notification.title, { body: payload.notification.body })
        }

        const params = new URL(window.location.href).searchParams
        const accessToken = params.get('accessToken')
        

    </script>
</body>
</html>